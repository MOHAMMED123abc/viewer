<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Niveau du R√©servoir</title>
  <!-- Tailwind CSS CDN for modern styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts - Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      overflow: hidden; /* Prevent scrollbars due to 3D scene */
    }
    #app-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: #e2e8f0; /* Light gray background */
      padding: 1rem;
    }
    #canvas-container {
      width: 100%;
      max-width: 600px; /* Max width for the 3D canvas */
      height: 400px; /* Fixed height for 3D canvas */
      background-color: #ffffff;
      border-radius: 1rem;
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #6b7280; /* Color for loading text */
      font-weight: 600;
    }
    canvas {
      display: block;
      width: 100% !important; /* Ensure canvas fills container */
      height: 100% !important; /* Ensure canvas fills container */
    }
    #level-display-card {
      background-color: #ffffff;
      border-radius: 1rem;
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      margin-top: 2rem;
      width: 90%;
      max-width: 450px;
      text-align: center;
    }
    #level {
      font-size: 3.5rem; /* Large font size for level */
      font-weight: 700;
      color: #28a745; /* Green color for level */
      margin-top: 1rem;
      transition: color 0.3s ease-in-out;
    }
    .text-loading {
      color: #6b7280; /* Grey for loading */
    }
    .text-error {
      color: #dc2626; /* Red for error */
    }
    .text-no-data {
      color: #f59e0b; /* Orange for no data */
    }
  </style>
</head>
<body>
  <div id="app-container">
    <div id="level-display-card" class="flex flex-col items-center">
      <h1 class="text-3xl font-bold text-gray-800 mb-4">Niveau du R√©servoir</h1>
      <div id="level" class="text-loading">...Chargement</div>
    </div>

    <div id="canvas-container" class="mt-8">
      Chargement du mod√®le 3D...
      <!-- Three.js canvas will be appended here -->
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <!-- Three.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- OrbitControls for camera interaction -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      databaseURL: "https://esp32-tank-project-default-rtdb.europe-west1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.database();

    // Get device ID from URL parameters
    const params = new URLSearchParams(window.location.search);
    const deviceId = params.get('device');

    const levelDisplay = document.getElementById('level');
    const canvasContainer = document.getElementById('canvas-container');

    // Three.js variables
    let scene, camera, renderer, tank, water, controls;
    const tankHeight = 5; // Height of the 3D tank model
    const tankRadius = 2; // Radius of the 3D tank model

    // Initialize Three.js scene
    function initThreeJS() {
      // Remove loading text from canvas container
      canvasContainer.innerHTML = '';

      // Scene
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xf0f4f8); // Light background for the scene

      // Camera
      camera = new THREE.PerspectiveCamera(75, canvasContainer.clientWidth / canvasContainer.clientHeight, 0.1, 1000);
      camera.position.set(0, tankHeight / 2 + 3, tankRadius * 4); // Position camera above and in front of the tank
      camera.lookAt(new THREE.Vector3(0, tankHeight / 2, 0)); // Make camera look at the center of the tank

      // Renderer
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
      canvasContainer.appendChild(renderer.domElement);

      // Lights
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
      scene.add(ambientLight);
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
      directionalLight.position.set(5, 10, 7);
      scene.add(directionalLight);

      // Tank geometry (outer shell)
      const tankGeometry = new THREE.CylinderGeometry(tankRadius, tankRadius, tankHeight, 32);
      const tankMaterial = new THREE.MeshPhongMaterial({
        color: 0xcccccc, // Grey color for the tank
        specular: 0x555555,
        shininess: 30,
        transparent: true,
        opacity: 0.6, // Make the tank slightly transparent to see water
        side: THREE.DoubleSide
      });
      tank = new THREE.Mesh(tankGeometry, tankMaterial);
      tank.position.y = tankHeight / 2; // Position tank so its base is at y=0
      scene.add(tank);

      // Water geometry
      // Use the same height for water geometry as tank geometry initially, then scale it
      const waterGeometry = new THREE.CylinderGeometry(tankRadius * 0.98, tankRadius * 0.98, tankHeight, 32);
      const waterMaterial = new THREE.MeshPhongMaterial({
        color: 0x1e90ff, // Dodger blue for water
        specular: 0x555555,
        shininess: 30,
        transparent: true,
        opacity: 0.8
      });
      water = new THREE.Mesh(waterGeometry, waterMaterial);
      // Initial scale and position to represent 0% water (hidden below the base)
      water.scale.y = 0.001; // Almost zero height
      water.position.y = -tankHeight / 2; // Position its center so its top is at y=0 when scaled to 0
      scene.add(water);

      // OrbitControls
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true; // Smooth camera movement
      controls.dampingFactor = 0.25;
      controls.screenSpacePanning = false;
      controls.maxPolarAngle = Math.PI / 2; // Prevent camera from going below ground
      controls.target.set(0, tankHeight / 2, 0); // Make controls orbit around the center of the tank

      // Handle window resizing
      window.addEventListener('resize', onWindowResize, false);

      // Start animation loop
      animate();
    }

    // Handle window resize for Three.js
    function onWindowResize() {
      // Update canvas dimensions based on container
      const newWidth = canvasContainer.clientWidth;
      const newHeight = canvasContainer.clientHeight;

      camera.aspect = newWidth / newHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(newWidth, newHeight);
    }

    // Animation loop
    function animate() {
      requestAnimationFrame(animate);
      controls.update(); // Only required if controls.enableDamping or controls.autoRotate are set to true
      renderer.render(scene, camera);
    }

    // Update water level based on percentage
    function updateWaterLevel(percentage) {
      if (water) {
        if (percentage === 0) {
          water.scale.y = 0.001; // Almost zero height
          water.position.y = -tankHeight / 2; // Position its center so its top is at y=0 when scaled to 0
        } else {
          const waterScale = percentage / 100;
          water.scale.y = waterScale;
          const actualWaterHeight = tankHeight * waterScale;
          // Position its center so its bottom is at y=0 (tank's base)
          water.position.y = actualWaterHeight / 2;
        }
      }
    }

    // Initialize Three.js when the window loads
    window.onload = initThreeJS;

    // Firebase data listener
    if (!deviceId) {
      levelDisplay.textContent = "‚ùå Appareil non sp√©cifi√©";
      levelDisplay.classList.add('text-error');
    } else {
      const tankRef = db.ref(`esp32/${deviceId}/tank`);

      tankRef.on("value", (snapshot) => {
        const level = snapshot.val();
        if (level !== null) {
          levelDisplay.textContent = `üîπ ${level}%`;
          levelDisplay.classList.remove('text-loading', 'text-error', 'text-no-data');
          // Dynamic color for the text based on level (green for high, red for low)
          levelDisplay.style.color = `hsl(${level * 1.2}, 70%, 40%)`;
          updateWaterLevel(level); // Update 3D tank
        } else {
          levelDisplay.textContent = "‚õîÔ∏è Aucune donn√©e";
          levelDisplay.classList.add('text-no-data');
          levelDisplay.classList.remove('text-loading', 'text-error');
          updateWaterLevel(0); // Show empty tank
        }
      }, (error) => {
        levelDisplay.textContent = "‚ö†Ô∏è Erreur de connexion";
        levelDisplay.classList.add('text-error');
        levelDisplay.classList.remove('text-loading', 'text-no-data');
        console.error(error);
        updateWaterLevel(0); // Show empty tank on error
      });
    }
  </script>
</body>
</html>
