<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
<meta name="theme-color" content="#0f172a">


  <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/48/water-drop.png?v=2">
<link rel="icon" sizes="192x192" href="https://img.icons8.com/fluency/192/water-drop.png?v=2">
<link rel="apple-touch-icon" href="https://img.icons8.com/fluency/180/water-drop.png?v=2">
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Tank Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap');
    body { background: #0f172a; color: #f8fafc; font-family: 'Rajdhani', sans-serif; }
    .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); border-radius: 2rem; }
    .tank-bg { width: 120px; height: 280px; background: #334155; border: 4px solid #475569; border-radius: 2rem; position: relative; overflow: hidden; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
    .water { width: 100%; position: absolute; bottom: 0; background: linear-gradient(180deg, #38bdf8 0%, #0284c7 100%); transition: all 1.5s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 20px rgba(56, 189, 248, 0.5); }
    .wave { position: absolute; top: -10px; left: 0; width: 200%; height: 20px; background: rgba(56, 189, 248, 0.3); border-radius: 40%; animation: moveWave 3s infinite linear; }
    @keyframes moveWave { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

@keyframes pulse-border {
    0% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(56, 189, 248, 0); }
    100% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0); }
}
    .update-container {
        margin-top: 25px;
        width: 100%;
        display: flex;
        justify-content: flex-start;
    }

    .btn-update-huge {
        background: rgba(56, 189, 248, 0.05);
        border: 1px solid rgba(56, 189, 248, 0.3);
        color: #38bdf8;
        padding: 15px 30px;
        border-radius: 1.2rem;
        font-family: 'Rajdhani', sans-serif;
        font-weight: 700;
        font-size: 1.1rem;
        letter-spacing: 2px;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: inset 0 0 15px rgba(56, 189, 248, 0.05);
    }

    /* تأثير عند تمرير الماوس */
    .btn-update-huge:hover {
        background: rgba(56, 189, 248, 0.15);
        border-color: #38bdf8;
        color: #fff;
        box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
        transform: scale(1.02);
    }

    /* حركة السهم المدور */
    .spinning {
        animation: spin 1s infinite linear;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }



    
.update-btn {
    animation: pulse-border 2s infinite;
}
    .value-font { font-family: 'Orbitron', sans-serif; }
    .refresh-icon-btn {
        background: none;
        border: none;
        color: #38bdf8; /* لون السماء الأزرق في تصميمك */
        cursor: pointer;
        font-size: 1.2rem;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        margin-left: 10px;
        vertical-align: middle;
    }

    .refresh-icon-btn:hover {
        color: #fff;
        text-shadow: 0 0 10px #38bdf8;
        transform: rotate(45deg);
    }

    .spinning {
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        100% { transform: rotate(360deg); }
    }


    /* تصميم الزر الجديد */
    .update-btn {
        background: rgba(56, 189, 248, 0.1);
        border: 2px solid #38bdf8;
        color: #38bdf8;
        padding: 12px 24px;
        border-radius: 1rem;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        width: 100%;
        margin-top: 20px;
    }

    .update-btn:hover {
        background: #38bdf8;
        color: #0f172a;
        box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
        transform: translateY(-2px);
    }

    .update-btn:active {
        transform: translateY(0);
    }
  </style>
</head>
<body class="p-4 md:p-8 flex justify-center items-center min-h-screen">

  <div class="max-w-4xl w-full grid grid-cols-1 md:grid-cols-3 gap-6">
    
    <div class="md:col-span-2 glass-card p-8 flex flex-col md:flex-row items-center justify-between gap-8">
      <div class="flex-1 text-center md:text-left">
        <h1 class="text-3xl font-bold text-sky-400 mb-2 uppercase tracking-widest">Niveau du Réservoir</h1>
        <div class="flex items-baseline justify-center md:justify-start gap-2">
          <span id="tankValue" class="text-8xl font-black text-white value-font">--</span>
          <span class="text-3xl font-bold text-sky-500">%</span>
        </div>
      
          
          <div class="flex items-center gap-3 text-gray-400">
  <i class="fas fa-water text-sky-400"></i>
  <span class="text-lg">Niveau d'eau: <b id="waterHeight" class="text-white">--</b> <small class="text-sky-400">cm</small></span>
</div>

<div class="space-y-4">
    <div class="flex items-center gap-3 text-gray-400">
        <i class="fas fa-clock text-blue-400"></i>
        <span class="text-lg">
            Dernière mise à jour: <br>
            <b id="lastSeen" class="text-sky-300 text-sm">--:--</b>
        </span>
    </div>

    <button onclick="updateData()" class="update-btn" id="refreshBtn">
        <i class="fas fa-sync-alt" id="refreshIcon"></i>
        <span>Appuyez pour mise à jour</span>
    </button>
</div>

          
        </div>
      </div>

      <div class="tank-bg">
        <div id="waterLevel" class="water" style="height: 0%;">
          <div class="wave"></div>
        </div>
      </div>
    </div>

    <div class="glass-card p-6 flex flex-col justify-between border-t-4 border-sky-500">
      <div>
        <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
          <i class="fas fa-cogs text-sky-400"></i> CONFIGURATION
        </h2>
        <div class="space-y-6">
          <div class="p-4 bg-slate-800/50 rounded-xl border border-slate-700">
            <p class="text-gray-400 text-sm mb-1">Hauteur Totale</p>
            <p class="text-2xl font-bold value-font"><span id="totalH">--</span> <small class="text-sm text-sky-400">cm</small></p>
          </div>
          <div class="p-4 bg-slate-800/50 rounded-xl border border-slate-700">
            <p class="text-gray-400 text-sm mb-1">Offset (Vider)</p>
            <p class="text-2xl font-bold value-font"><span id="offsetV">--</span> <small class="text-sm text-sky-400">cm</small></p>
          </div>
        </div>
      </div>
      
      <div class="mt-8 pt-4 border-t border-slate-700 text-center">
        <p class="text-xs text-slate-500 uppercase tracking-tighter">ID Appareil: <span id="devID" class="text-slate-300">---</span></p>
      </div>
    </div>

  </div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAYge0HyYiL0-vlXnnlB_FqAZvocb_lz9Y",
            databaseURL: "https://esp32-tank-project-default-rtdb.europe-west1.firebasedatabase.app"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // تفعيل الدخول المجهول
        firebase.auth().signInAnonymously().catch((error) => {
            console.error("Auth Error:", error.message);
        });

        const urlParams = new URLSearchParams(window.location.search);
        const deviceId = urlParams.get('device') || 'device0002'; 
        document.getElementById('devID').textContent = deviceId;

        let finalPath = deviceId;
        if (!deviceId.startsWith('device')) {
            finalPath = "devices/" + deviceId;
        }

        // ... (نفس كود الإعداد والـ Auth) ...

const deviceRef = db.ref(finalPath);

function updateData() {
    const icon = document.getElementById('refreshIcon');
    icon.classList.add('spinning'); // إضافة حركة الدوران

    deviceRef.once("value").then((snapshot) => {
        const data = snapshot.val();
        if (data) {
            // ... (نفس الكود القديم الخاص بتحديث البيانات) ...
            const tank = data.tank || 0;
            document.getElementById('tankValue').innerText = tank;
            document.getElementById('waterLevel').style.height = tank + "%";

  if (tank < 15) {
    valEl.classList.add('animate-pulse', 'text-red-500');
    valEl.classList.remove('text-white');
    waterColor.style.filter = "hue-rotate(300deg)"; // يتحول للون الأحمر/الأرجواني للتنبيه
} else {
    valEl.classList.remove('animate-pulse', 'text-red-500');
    valEl.classList.add('text-white');
    waterColor.style.filter = "hue-rotate(0deg)";
}
            if (data.water_height !== undefined) {
                document.getElementById('waterHeight').innerText = data.water_height.toFixed(1);
            }

            if (data.last_seen) {
                const date = new Date(data.last_seen);
                const options = { hour: '2-digit', minute: '2-digit', second: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric' };
                document.getElementById('lastSeen').innerText = date.toLocaleString('fr-FR', options);
            }

            if(data.config) {
                document.getElementById('totalH').innerText = data.config.totalHeight || "--";
                document.getElementById('offsetV').innerText = data.config.sensorOffset || "--";
            }
        }
        
        // إيقاف الدوران بعد ثانية واحدة
        setTimeout(() => {
            icon.classList.remove('spinning');
        }, 1000);

    }).catch((error) => {
        console.error("Firebase Error:", error);
        icon.classList.remove('spinning');
    });
}
// استدعاء الدالة عند تحميل الصفحة لأول مرة
updateData();

// اختياري: إضافة زر "تحديث" يدوي بدلاً من تحديث الصفحة كاملة
//  <button onclick="updateData()">Mettre à jour</button>
  </script>
</body>
</html>






